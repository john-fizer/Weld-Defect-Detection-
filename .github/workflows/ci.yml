name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black==24.10.0 ruff==0.7.1 mypy==1.13.0
    
    - name: Check code formatting with Black
      run: |
        black --check --diff src/ scripts/
    
    - name: Lint with Ruff
      run: |
        ruff check src/ scripts/
    
    - name: Type check with MyPy
      run: |
        mypy src/ scripts/ --install-types --non-interactive || true
      continue-on-error: true

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
    
    - name: Check dependencies for known vulnerabilities
      run: |
        pip install -r requirements.txt
        safety check --json || true
      continue-on-error: true
    
    - name: Security scan with Bandit
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
      continue-on-error: true
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest==8.3.3 pytest-cov==6.0.0
        # Install minimal dependencies for testing (skip heavy ML libraries)
        pip install numpy==1.26.4 pandas==2.2.3 pillow==10.4.0
        pip install scikit-learn==1.5.2 tqdm==4.66.5 pyyaml==6.0.2
        pip install omegaconf==2.3.0 hydra-core==1.3.2
        pip install loguru==0.7.2 typer==0.12.5
    
    - name: Create test directories
      run: |
        mkdir -p data/raw data/clean_real data/synthetic data/merged
        mkdir -p models/lama models/lora models/classifier models/onnx
        mkdir -p logs outputs
    
    - name: Run tests with pytest
      run: |
        pytest --verbose --cov=src --cov-report=xml --cov-report=html || echo "No tests found"
      continue-on-error: true
    
    - name: Upload coverage reports
      if: matrix.python-version == '3.10'
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate

  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Verify package structure
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        python -m build --version || echo "Build tool check complete"
    
    - name: Check import structure
      run: |
        python -c "import sys; print(f'Python {sys.version}')"
        python -c "from pathlib import Path; print('Path imports OK')"
    
    - name: Validate configuration files
      run: |
        python -c "import yaml; yaml.safe_load(open('conf/train.yaml'))"
        echo "Configuration files validated"

  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-scan, test, build-check]
    if: always()
    
    steps:
    - name: Check job results
      run: |
        if [[ "${{ needs.lint-and-format.result }}" == "failure" ]]; then
          echo "Code quality checks failed"
          exit 1
        fi
        if [[ "${{ needs.test.result }}" == "failure" ]]; then
          echo "Tests failed"
          exit 1
        fi
        if [[ "${{ needs.build-check.result }}" == "failure" ]]; then
          echo "Build verification failed"
          exit 1
        fi
        echo "All required checks passed!"
